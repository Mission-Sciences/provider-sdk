import { JWTParser } from './JWTParser';
import { JWKSValidator } from './JWKSValidator';
import { TimerManager } from './TimerManager';
import { WarningModal } from '../ui/WarningModal';
import { extractTokenFromURL } from '../utils/url';
import { Logger } from '../utils/logger';
import { SDKConfig, SDKEvents, SessionData, SDKError } from '../types';

/**
 * Main Marketplace SDK class
 */
export class MarketplaceSDK {
  private config: Required<SDKConfig>;
  private validator: JWKSValidator;
  private timer: TimerManager | null = null;
  private modal: WarningModal | null = null;
  private logger: Logger;
  private events: Partial<SDKEvents> = {};
  private sessionData: SessionData | null = null;
  private jwtToken: string | null = null;

  constructor(config: SDKConfig) {
    this.config = {
      jwksUri: config.jwksUri || 'https://api.generalwisdom.com/.well-known/jwks.json',
      debug: config.debug ?? false,
      autoStart: config.autoStart ?? true,
      warningThresholdSeconds: config.warningThresholdSeconds ?? 300,
      customStyles: config.customStyles ?? {},
      applicationId: config.applicationId ?? '',
    };

    this.validator = new JWKSValidator(this.config.jwksUri, this.config.debug);
    this.logger = new Logger(this.config.debug, '[MarketplaceSDK]');

    this.logger.info('SDK initialized with config:', {
      jwksUri: this.config.jwksUri,
      debug: this.config.debug,
      autoStart: this.config.autoStart,
      warningThresholdSeconds: this.config.warningThresholdSeconds,
    });
  }

  /**
   * Register event handlers
   */
  on<K extends keyof SDKEvents>(event: K, handler: SDKEvents[K]): void {
    this.events[event] = handler;
    this.logger.log('Event handler registered:', event);
  }

  /**
   * Initialize SDK and validate session
   */
  async initialize(): Promise<SessionData> {
    this.logger.info('Initializing session...');

    try {
      // Extract JWT from URL
      this.jwtToken = extractTokenFromURL('gwSession');
      if (!this.jwtToken) {
        throw new SDKError(
          'No gwSession token found in URL',
          'MISSING_TOKEN'
        );
      }

      this.logger.log('JWT token extracted from URL');

      // First decode to get basic info (client-side only)
      const decodedClaims = JWTParser.decode(this.jwtToken);
      this.logger.log('JWT decoded (unverified):', decodedClaims);

      // Verify JWT signature with JWKS
      const verifiedClaims = await this.validator.verify(
        this.jwtToken,
        'generalwisdom.com',
        this.config.applicationId || undefined
      );

      this.logger.log('JWT signature verified');

      // Map to SessionData
      this.sessionData = {
        sessionId: verifiedClaims.sessionId,
        applicationId: verifiedClaims.applicationId,
        userId: verifiedClaims.userId,
        orgId: verifiedClaims.orgId,
        startTime: verifiedClaims.startTime,
        durationMinutes: verifiedClaims.durationMinutes,
        iat: verifiedClaims.iat,
        exp: verifiedClaims.exp,
        iss: verifiedClaims.iss,
        sub: verifiedClaims.sub,
      };

      // Calculate remaining time
      const now = Math.floor(Date.now() / 1000);
      const remainingSeconds = Math.max(0, this.sessionData.exp - now);

      if (remainingSeconds <= 0) {
        throw new SDKError(
          'Session has already expired',
          'SESSION_EXPIRED'
        );
      }

      this.logger.log('Remaining time:', remainingSeconds, 'seconds');

      // Initialize timer
      this.timer = new TimerManager(
        remainingSeconds,
        this.config.warningThresholdSeconds,
        {
          onSessionWarning: (data) => {
            this.showWarningModal(data.remainingSeconds);
            this.events.onSessionWarning?.(data);
          },
          onSessionEnd: () => {
            this.endSession();
          },
        },
        this.config.debug
      );

      // Start timer if autoStart enabled
      if (this.config.autoStart) {
        this.timer.start();
        this.logger.log('Timer started automatically');
      }

      // Trigger session start event
      this.events.onSessionStart?.(this.sessionData);

      this.logger.info('Session initialized successfully');
      return this.sessionData;
    } catch (error) {
      this.logger.error('Initialization failed:', error);
      const sdkError = error instanceof SDKError ? error : new SDKError(
        error instanceof Error ? error.message : 'Unknown error',
        'INITIALIZATION_ERROR'
      );
      this.events.onError?.(sdkError);
      throw sdkError;
    }
  }

  /**
   * Start session timer manually
   */
  startTimer(): void {
    if (!this.timer) {
      throw new SDKError(
        'SDK not initialized. Call initialize() first.',
        'NOT_INITIALIZED'
      );
    }
    this.timer.start();
    this.logger.info('Timer started manually');
  }

  /**
   * Pause session timer
   */
  pauseTimer(): void {
    this.timer?.pause();
    this.logger.info('Timer paused');
  }

  /**
   * Resume session timer
   */
  resumeTimer(): void {
    this.timer?.resume();
    this.logger.info('Timer resumed');
  }

  /**
   * End session
   */
  endSession(): void {
    this.logger.info('Ending session...');

    // Stop timer
    this.timer?.stop();

    // Hide modal
    this.modal?.hide();

    // Trigger end event
    this.events.onSessionEnd?.();

    this.logger.info('Session ended');
  }

  /**
   * Show warning modal
   */
  private showWarningModal(remainingSeconds: number): void {
    if (!this.modal) {
      this.modal = new WarningModal(this.config.customStyles);
    }

    this.modal.show({
      remainingSeconds,
      onEnd: () => {
        this.endSession();
      },
    });
  }

  /**
   * Get current session data
   */
  getSessionData(): SessionData | null {
    return this.sessionData;
  }

  /**
   * Get remaining time
   */
  getRemainingTime(): number {
    return this.timer?.getRemainingSeconds() ?? 0;
  }

  /**
   * Get formatted time (MM:SS)
   */
  getFormattedTime(): string {
    return this.timer?.getFormattedTime() ?? '0:00';
  }

  /**
   * Get formatted time with hours (HH:MM:SS)
   */
  getFormattedTimeWithHours(): string {
    return this.timer?.getFormattedTimeWithHours() ?? '0:00:00';
  }

  /**
   * Check if timer is running
   */
  isTimerRunning(): boolean {
    return this.timer?.isRunning() ?? false;
  }

  /**
   * Cleanup and destroy SDK instance
   */
  destroy(): void {
    this.logger.info('Destroying SDK instance...');
    this.timer?.stop();
    this.modal?.hide();
    this.sessionData = null;
    this.jwtToken = null;
  }
}
