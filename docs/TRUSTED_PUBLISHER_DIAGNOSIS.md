# Trusted Publisher Issue Diagnosis

## Current Status

After multiple attempts, npm publishing still fails with:
```
npm notice publish Signed provenance statement with source and build information from GitHub Actions
npm notice publish Provenance statement published to transparency log
npm notice Access token expired or revoked. Please try logging in again.
npm error 404 Not Found - PUT https://registry.npmjs.org/@mission_sciences%2fprovider-sdk - Not found
```

## What's Working

✅ Trusted publisher configuration exists on npm.com:
- Organization: `Mission-Sciences`
- Repository: `provider-sdk`
- Workflow: `publish-package.yml`

✅ Provenance signing works:
- OIDC token is being generated by GitHub
- Provenance is published to Sigstore transparency log

## What's NOT Working

❌ npm is receiving a token instead of using OIDC:
- Message: "Access token expired or revoked"
- This means npm is getting NODE_AUTH_TOKEN
- It's trying token auth instead of trusted publisher

## Root Cause

The environment variables `NODE_AUTH_TOKEN` and `NPM_CONFIG_USERCONFIG` are being set by GitHub Actions automatically, overriding OIDC authentication.

## Possible Solutions

### Solution 1: Check for NPM_TOKEN Secret

GitHub Actions automatically injects `NODE_AUTH_TOKEN` if an `NPM_TOKEN` secret exists:

```bash
# Check secrets
gh secret list | grep NPM

# If NPM_TOKEN exists, DELETE IT:
gh secret delete NPM_TOKEN
```

Trusted publisher doesn't need secrets!

### Solution 2: Verify Organization Settings

The trusted publisher might be configured at USER level but not ORGANIZATION level:

1. Go to: https://www.npmjs.com/settings/@mission_sciences/packages/@mission_sciences/provider-sdk/access
2. **NOT**: https://www.npmjs.com/settings/your-user/packages/...

The package is under `@mission_sciences` organization, so trusted publisher must be configured at the **organization level**.

### Solution 3: Check npm Organization Members

1. Go to: https://www.npmjs.com/org/mission_sciences/members
2. Verify the GitHub account that owns the `Mission-Sciences` org has publish permissions
3. The GitHub org owner must match the npm org member

### Solution 4: Alternative Approach - Use a Separate Job

Create a dedicated publish job with NO other npm operations:

```yaml
publish-npm-trusted:
  name: npm Trusted Publisher
  runs-on: ubuntu-latest
  needs: [test-and-build]
  permissions:
    contents: read
    id-token: write

  steps:
    - uses: actions/checkout@v4

    # DON'T use setup-node at all!
    - name: Install Node manually
      run: |
        curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
        apt-get install -y nodejs

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: Publish with pure npm
      run: |
        # No npm ci, no setup-node, no .npmrc
        npm publish --provenance --access public
```

## Next Steps

1. **Check for NPM_TOKEN secret** - Most likely culprit
2. **Verify org-level trusted publisher config** - Not user-level
3. **Try the separate job approach** - Cleanest solution

---

**The key insight**: npm can ONLY use trusted publisher if NO token is provided. Any token (even expired) makes npm try token auth instead of OIDC.
