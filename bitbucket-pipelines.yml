# Bitbucket Pipeline for Marketplace Provider SDK
# Deploys CodeArtifact infrastructure and publishes npm package on push to main
#
# Required Workspace Variables:
#   - OIDC_ROLE_ARN (secured) - ARN of the IAM role to assume via OIDC
#   - AWS_DEFAULT_REGION (value: us-east-1)

image: node:20

definitions:
  caches:
    node_modules: node_modules

  steps:
    - step: &test
        name: Run Tests
        caches:
          - node_modules
        script:
          - npm ci
          - npm run lint
          - npm run test

    - step: &build
        name: Build Package
        caches:
          - node_modules
        script:
          - npm ci
          - npm run build
        artifacts:
          - dist/**

    - step: &terraform-plan
        name: Terraform Plan (CodeArtifact)
        image: hashicorp/terraform:1.6
        oidc: true
        script:
          # Install AWS CLI for OIDC authentication
          - apk add --no-cache aws-cli

          # Assume AWS role via OIDC
          - export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $(aws sts assume-role-with-web-identity --role-arn ${OIDC_ROLE_ARN} --role-session-name bitbucket-pipeline --web-identity-token ${BITBUCKET_STEP_OIDC_TOKEN} --duration-seconds 3600 --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --output text))
          - echo "✓ AWS credentials obtained via OIDC"

          # Run Terraform plan
          - echo "Planning CodeArtifact infrastructure..."
          - cd terraform
          - terraform init -reconfigure -upgrade
          - terraform plan -out=tfplan
          - echo "✓ Terraform plan completed"
        artifacts:
          - terraform/.terraform/**
          - terraform/.terraform.lock.hcl
          - terraform/tfplan

    - step: &terraform-apply
        name: Terraform Apply (CodeArtifact)
        image: hashicorp/terraform:1.6
        oidc: true
        script:
          # Install AWS CLI for OIDC authentication
          - apk add --no-cache aws-cli

          # Assume AWS role via OIDC
          - export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $(aws sts assume-role-with-web-identity --role-arn ${OIDC_ROLE_ARN} --role-session-name bitbucket-pipeline --web-identity-token ${BITBUCKET_STEP_OIDC_TOKEN} --duration-seconds 3600 --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --output text))
          - echo "✓ AWS credentials obtained via OIDC"

          # Apply Terraform plan
          - echo "Deploying CodeArtifact infrastructure..."
          - cd terraform
          - terraform init -reconfigure
          - terraform apply -auto-approve tfplan
          - echo "✓ CodeArtifact infrastructure deployed"

          # Extract outputs
          - export CODEARTIFACT_DOMAIN=$(terraform output -raw codeartifact_domain 2>/dev/null || echo "ghostdogbase")
          - export CODEARTIFACT_REPOSITORY=$(terraform output -raw codeartifact_repository 2>/dev/null || echo "sdk-packages")
          - echo "CODEARTIFACT_DOMAIN=$CODEARTIFACT_DOMAIN" >> ../deployment-outputs.env
          - echo "CODEARTIFACT_REPOSITORY=$CODEARTIFACT_REPOSITORY" >> ../deployment-outputs.env
        artifacts:
          - terraform/.terraform/**
          - terraform/.terraform.lock.hcl
          - deployment-outputs.env

    - step: &publish-codeartifact
        name: Publish to AWS CodeArtifact
        oidc: true
        script:
          # Install AWS CLI
          - apt-get update && apt-get install -y awscli

          # Assume AWS role via OIDC
          - export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s" $(aws sts assume-role-with-web-identity --role-arn ${OIDC_ROLE_ARN} --role-session-name bitbucket-pipeline --web-identity-token ${BITBUCKET_STEP_OIDC_TOKEN} --duration-seconds 3600 --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --output text))
          - echo "✓ AWS credentials obtained via OIDC"

          # Configure npm to use CodeArtifact
          - echo "Configuring npm for CodeArtifact..."
          - aws codeartifact login --tool npm --domain ghostdogbase --repository sdk-packages --region us-east-1

          # Verify package.json version
          - PACKAGE_VERSION=$(node -p "require('./package.json').version")
          - echo "Publishing version $PACKAGE_VERSION to CodeArtifact..."

          # Publish package
          - npm publish || echo "⚠️ Publish failed (version may already exist)"

          - echo "✓ Package published successfully"

pipelines:
  branches:
    main:
      - step: *test
      - step: *build
      - step: *terraform-plan
      - step: *terraform-apply
      - step: *publish-codeartifact

  pull-requests:
    '**':
      - step: *test
      - step: *build
